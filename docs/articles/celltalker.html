<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>celltalker • celltalker</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="celltalker">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">celltalker</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.4.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/celltalker.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="celltalker_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>celltalker</h1>
                        <h4 class="author">Anthony R Cillo</h4>
            
            <h4 class="date">28 March, 2022</h4>
      
      
      <div class="hidden name"><code>celltalker.Rmd</code></div>

    </div>

    
    
<p>Welcome to celltalker. This vignette will show the simpliest use case of celltalker, namely and identification the top putative ligand and receptor interactions across cell types from the Human Cell Atlas 40,000 Bone Marrow Cells dataset. This dataset is publicly available in a convenient form the SeuratData package. Check out instructions for downloading this dataset (hcabm40k) <a href="https://github.com/satijalab/seurat-data">here</a>.</p>
<div id="set-up-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-analysis" class="anchor"></a>Set up analysis</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(celltalker)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat)</span></code></pre></div>
<pre><code>## This version of bslib is designed to work with shiny version 1.5.0.9007 or higher.</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SeuratData)</span></code></pre></div>
<pre><code>## Registered S3 method overwritten by 'cli':
##   method     from    
##   print.boxx spatstat</code></pre>
<pre><code>## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used

## Warning in if (is.na(desc)) {: the condition has length &gt; 1 and only the first
## element will be used</code></pre>
<pre><code>## ── Installed datasets ───────────────────────────────────── SeuratData v0.2.1 ──</code></pre>
<pre><code>## ✔ cbmc     3.1.4                        ✔ pbmc3k   3.1.4
## ✔ hcabm40k 3.0.0</code></pre>
<pre><code>## ────────────────────────────────────── Key ─────────────────────────────────────</code></pre>
<pre><code>## ✔ Dataset loaded successfully
## ❯ Dataset built with a newer version of Seurat than installed
## ❓ Unknown version of Seurat installed</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.0 ──</code></pre>
<pre><code>## ✔ ggplot2 3.3.2     ✔ purrr   0.3.3
## ✔ tibble  3.0.5     ✔ dplyr   1.0.3
## ✔ tidyr   1.0.0     ✔ stringr 1.4.0
## ✔ readr   1.3.1     ✔ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load CMBC data</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(hcabm40k)</span></code></pre></div>
</div>
<div id="dimensional-reduction-and-clustering" class="section level2">
<h2 class="hasAnchor">
<a href="#dimensional-reduction-and-clustering" class="anchor"></a>Dimensional reduction and clustering</h2>
<p>First, we will perform and standard workflow to identify the major cell types based on canonical gene expression.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>cbmc <span class="ot">&lt;-</span> hcabm40k <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NormalizeData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">RunPCA</span>()</span></code></pre></div>
<pre><code>## Centering and scaling data matrix</code></pre>
<pre><code>## PC_ 1 
## Positive:  TMSB4X, NKG7, LAT, KLRB1, CD74, MS4A1, SOCS3, GNLY, IGHD, GZMH 
##     CD79A, HLA-DQB1, KLRD1, GZMK, S100A12, RGS1, FGFBP2, CCL4, IGKC, FCN1 
##     LGALS1, HLA-DPB1, SERPINA1, PRF1, GZMB, CD14, HLA-DQA1, IGLC2, VCAN, RGS2 
## Negative:  AHSP, KIAA0101, FAM178B, KLF1, KCNH2, TYMS, CA1, CA2, GATA1, HBD 
##     EPCAM, APOC1, GYPA, RHAG, HBB, HBQ1, SMIM1, MYL4, HMBS, CENPU 
##     CCNB2, CKS2, BIRC5, ALAS2, BLVRB, PCNA, TUBB, HBA1, SYNGR1, CDT1 
## PC_ 2 
## Positive:  LYZ, CST3, S100A9, LST1, S100A8, FCN1, LGALS1, FCER1G, VCAN, MNDA 
##     S100A12, CFD, SERPINA1, MS4A6A, CD14, PLAUR, GAPDH, MGST1, ACTB, ANXA2 
##     RP11-1143G9.4, CEBPD, LGALS2, S100A6, RNASE2, HLA-DRA, MAFB, RETN, IFI30, H2AFY 
## Negative:  EEF1B2, RPS2, RPL7A, RPLP0, GYPC, LAT, GYPA, ALAS2, AHSP, PRDX2 
##     CA1, GYPB, HSPA8, RHAG, NPM1, RPL37A, MYL4, HBM, LDHB, TMEM56 
##     KCNH2, KLF1, HBD, SOD1, SLC4A1, KLRB1, HEMGN, CA2, FAM178B, RFESD 
## PC_ 3 
## Positive:  S100A6, FCN1, CD36, GYPA, ALAS2, S100A9, S100A12, S100A8, GYPB, HBM 
##     FTH1, BLVRB, SLC4A1, VCAN, SERPINA1, HBA2, HBA1, AHSP, LGALS3, CA2 
##     CD14, RHAG, LYZ, CA1, HBD, TMEM56, CTSE, HEMGN, HBB, G0S2 
## Negative:  IGLL1, STMN1, VPREB1, SOX4, SMIM24, VPREB3, CD79B, PRSS57, ITM2C, FABP5 
##     MZB1, SPINK2, CD24, KIAA0125, PHGDH, CDCA7, C1QTNF4, NREP, CD34, UHRF1 
##     DNTT, TCF4, AC002454.1, PTMA, PDLIM1, IGHM, CD79A, TCL1A, EGFL7, CD9 
## PC_ 4 
## Positive:  PRSS57, CYTL1, NPW, NPR3, PTRF, MEST, NKG7, NGFRAP1, LDHB, SPINK2 
##     SERPINE2, EGFL7, AP001171.1, C1QTNF4, CRYGD, GNLY, FSCN1, GATA2, KLRD1, KLRB1 
##     PRF1, WBP5, MAP7, ITGA2B, CNRIP1, CMBL, HACD1, CD34, MT2A, CMC1 
## Negative:  CD79A, CD79B, VPREB3, IGHM, TCL1A, HLA-DRA, CD24, CD74, HLA-DQB1, IGHD 
##     HLA-DRB1, VPREB1, HLA-DPB1, MS4A1, HLA-DPA1, IGKC, HLA-DQA1, NUSAP1, MKI67, SPIB 
##     TOP2A, IGLC2, CD72, MZB1, POU2AF1, AURKB, CD9, JCHAIN, EBF1, IGLC3 
## PC_ 5 
## Positive:  NKG7, GNLY, KLRD1, PRF1, GZMB, FGFBP2, KLRF1, GZMH, CMC1, CCL4 
##     KLRB1, SPON2, TRDC, CLIC3, TMSB4X, PFN1, C12orf75, FCGR3A, XCL2, CD160 
##     UBE2C, NUSAP1, MKI67, TRGC1, TOP2A, AURKB, TRGC2, KLRC1, ACTB, MT2A 
## Negative:  HLA-DRA, CD79A, MS4A1, HLA-DQB1, IGHD, HLA-DQA1, CD74, IGHM, HLA-DRB1, HLA-DPA1 
##     IGKC, HLA-DPB1, CD79B, IGLC2, KIAA0125, RPS2, TCL1A, IGLC3, PKIG, RPLP0 
##     JCHAIN, RPL37A, RPL7A, TSPAN13, CYTL1, CNRIP1, VPREB3, RP5-887A10.1, FTH1, ALDH1A1</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ElbowPlot</span>(cbmc)</span></code></pre></div>
<p><img src="celltalker_files/figure-html/cluster-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cbmc <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(cbmc,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FindNeighbors</span>(.,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FindClusters</span>(.,<span class="at">res=</span><span class="fl">0.7</span>)</span></code></pre></div>
<pre><code>## Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
## To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'
## This message will be shown once per session</code></pre>
<pre><code>## 20:31:18 UMAP embedding parameters a = 0.9922 b = 1.112</code></pre>
<pre><code>## 20:31:18 Read 40000 rows and found 8 numeric columns</code></pre>
<pre><code>## 20:31:18 Using Annoy for neighbor search, n_neighbors = 30</code></pre>
<pre><code>## 20:31:18 Building Annoy index with metric = cosine, n_trees = 50</code></pre>
<pre><code>## 0%   10   20   30   40   50   60   70   80   90   100%</code></pre>
<pre><code>## [----|----|----|----|----|----|----|----|----|----|</code></pre>
<pre><code>## **************************************************|
## 20:31:23 Writing NN index file to temp file /var/folders/_p/n2bykf5555bcpmdl3yfw8y540000gn/T//RtmpdEKrJU/filebba67432cae0
## 20:31:24 Searching Annoy index using 1 thread, search_k = 3000
## 20:31:40 Annoy recall = 100%
## 20:31:40 Commencing smooth kNN distance calibration using 1 thread
## 20:31:42 Initializing from normalized Laplacian + noise
## 20:31:50 Commencing optimization for 200 epochs, with 1633838 positive edges
## 20:32:09 Optimization finished
## Computing nearest neighbor graph
## Computing SNN</code></pre>
<pre><code>## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck
## 
## Number of nodes: 40000
## Number of edges: 1158441
## 
## Running Louvain algorithm...
## Maximum modularity in 10 random starts: 0.8967
## Number of communities: 18
## Elapsed time: 13 seconds</code></pre>
</div>
<div id="assign-cell-types" class="section level2">
<h2 class="hasAnchor">
<a href="#assign-cell-types" class="anchor"></a>Assign cell types</h2>
<p>Next, we will assign the cell types.</p>
<p>For this exemplary analysis with celltalker, we will filter out the transitional subpopulations to focus purely on putative interactions between canonical cell types. The transitional populations are intriguing - but are beyond the scope of this simple vignette.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out clusters</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(cbmc,<span class="at">group.by=</span><span class="st">"RNA_snn_res.0.7"</span>,<span class="at">label=</span>T)</span></code></pre></div>
<pre><code>## Warning: Using `as.character()` on a quosure is deprecated as of rlang 0.3.0.
## Please use `as_label()` or `as_name()` instead.
## This warning is displayed once per session.</code></pre>
<p><img src="celltalker_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(cbmc,<span class="fu">c</span>(<span class="st">"CD34"</span>,<span class="st">"CD14"</span>,<span class="st">"FCGR3A"</span>,<span class="st">"MS4A1"</span>,<span class="st">"CD1C"</span>,<span class="st">"IL3RA"</span>))</span></code></pre></div>
<p><img src="celltalker_files/figure-html/unnamed-chunk-1-2.png" width="700"></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(cbmc,<span class="fu">c</span>(<span class="st">"CD3D"</span>,<span class="st">"CD4"</span>,<span class="st">"CD8A"</span>,<span class="st">"FCGR3A"</span>,<span class="st">"HBB"</span>))</span></code></pre></div>
<p><img src="celltalker_files/figure-html/unnamed-chunk-1-3.png" width="700"></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out cell types</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>cell_types <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"logical"</span>,<span class="at">length=</span><span class="fu">ncol</span>(cbmc))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cell_types) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(cbmc)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"0"</span> <span class="sc">|</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"2"</span> <span class="sc">|</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"6"</span> ] <span class="ot">&lt;-</span> <span class="st">"CD4 T cells"</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"3"</span>] <span class="ot">&lt;-</span> <span class="st">"CD8 T cells"</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"5"</span>] <span class="ot">&lt;-</span> <span class="st">"NK cells"</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"8"</span> <span class="sc">|</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"11"</span>] <span class="ot">&lt;-</span> <span class="st">"RBCs"</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"1"</span>] <span class="ot">&lt;-</span> <span class="st">"CD14 monocytes"</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"14"</span>] <span class="ot">&lt;-</span> <span class="st">"CD16 monocytes"</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"15"</span>] <span class="ot">&lt;-</span> <span class="st">"CD1C DC"</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"10"</span>] <span class="ot">&lt;-</span> <span class="st">"CD34 HPSC"</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>cell_types[cbmc<span class="sc">@</span>meta.data<span class="sc">$</span>RNA_snn_res.<span class="fl">0.7</span><span class="sc">==</span><span class="st">"4"</span>] <span class="ot">&lt;-</span> <span class="st">"B cells"</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>cbmc[[<span class="st">"cell_types"</span>]] <span class="ot">&lt;-</span> cell_types</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter cells - remove transitional cell populations and RBCs</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>cbmc_filtered <span class="ot">&lt;-</span> cbmc[,<span class="sc">!</span>cbmc[[<span class="st">"cell_types"</span>]]<span class="sc">==</span><span class="st">"FALSE"</span>]</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>cbmc_filtered <span class="ot">&lt;-</span> cbmc_filtered[,<span class="sc">!</span>cbmc_filtered[[<span class="st">"cell_types"</span>]]<span class="sc">==</span><span class="st">"RBCs"</span>]</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out final object</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(cbmc_filtered,<span class="at">group.by=</span><span class="st">"cell_types"</span>)</span></code></pre></div>
<p><img src="celltalker_files/figure-html/unnamed-chunk-1-4.png" width="700"></p>
</div>
<div id="create-mean-expression-matrices" class="section level2">
<h2 class="hasAnchor">
<a href="#create-mean-expression-matrices" class="anchor"></a>Create mean expression matrices</h2>
<p>Now, we will create ligand and receptor by cell type matrices that summarize the mean expression level of a given ligand or receptor. But first we will only keep cell types that have 100 or more cells and we will only keep ligands that are expressed at greater than 1000 and less than 20000 across all cell types.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter by cells present - require 100 cells</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(cbmc_filtered<span class="sc">@</span>meta.data<span class="sc">$</span>cell_types)</span></code></pre></div>
<pre><code>## 
##        B cells CD14 monocytes CD16 monocytes        CD1C DC      CD34 HPSC 
##           4864           5536            533            428            935 
##    CD4 T cells    CD8 T cells       NK cells 
##          13813           4950           2780</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>cell_types_keep <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">table</span>(cbmc_filtered<span class="sc">@</span>meta.data<span class="sc">$</span>cell_types))[<span class="fu">table</span>(cbmc_filtered<span class="sc">@</span>meta.data<span class="sc">$</span>cell_types)<span class="sc">&gt;</span><span class="dv">100</span>]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter cells</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>cbmc_filtered <span class="ot">&lt;-</span> cbmc_filtered[,cbmc_filtered<span class="sc">@</span>meta.data<span class="sc">$</span>cell_types <span class="sc">%in%</span> cell_types_keep]</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter genes</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>ligs.recs.all <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(<span class="fu">unique</span>(<span class="fu">as.character</span>(ramilowski_pairs<span class="sc">$</span>ligand)),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">unique</span>(<span class="fu">as.character</span>(ramilowski_pairs<span class="sc">$</span>receptor))))</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>ligs.recs.use <span class="ot">&lt;-</span> ligs.recs.all[ligs.recs.all <span class="sc">%in%</span> <span class="fu">rownames</span>(cbmc_filtered)]</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>overall.lig.rec <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(cbmc_filtered,<span class="at">slot=</span><span class="st">"counts"</span>,<span class="at">assay=</span><span class="st">"RNA"</span>)[ligs.recs.use,]</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>ligs.keep <span class="ot">&lt;-</span> <span class="fu">apply</span>(overall.lig.rec,<span class="dv">1</span>,sum)[<span class="fu">apply</span>(overall.lig.rec,<span class="dv">1</span>,sum)<span class="sc">&gt;</span><span class="dv">1000</span> <span class="sc">&amp;</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">apply</span>(overall.lig.rec,<span class="dv">1</span>,sum)<span class="sc">&lt;</span><span class="dv">20000</span>]</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>cbmc_filtered <span class="ot">&lt;-</span> cbmc_filtered[<span class="fu">names</span>(ligs.keep),]</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Split object</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>pbmc3k_filtered_split <span class="ot">&lt;-</span> <span class="fu">SplitObject</span>(cbmc_filtered,<span class="at">split=</span><span class="st">"cell_types"</span>)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>expr_ligs <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind,<span class="fu">lapply</span>(pbmc3k_filtered_split ,<span class="cf">function</span>(x) {</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  expr <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(x,<span class="at">assay=</span><span class="st">"RNA"</span>,<span class="at">slot=</span><span class="st">"data"</span>)</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(expr[<span class="fu">rownames</span>(expr) <span class="sc">%in%</span> ramilowski_pairs<span class="sc">$</span>ligand,],<span class="dv">1</span>,mean)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>expr_recs <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind,<span class="fu">lapply</span>(pbmc3k_filtered_split,<span class="cf">function</span>(x) {</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>  expr <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(x,<span class="at">assay=</span><span class="st">"RNA"</span>,<span class="at">slot=</span><span class="st">"data"</span>)</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(expr[<span class="fu">rownames</span>(expr) <span class="sc">%in%</span> ramilowski_pairs<span class="sc">$</span>receptor,],<span class="dv">1</span>,mean)</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>}))</span></code></pre></div>
</div>
<div id="run-celltalker" class="section level2">
<h2 class="hasAnchor">
<a href="#run-celltalker" class="anchor"></a>Run celltalker</h2>
<p>These three function take the ligand and receptor matrices created above and create a joint mean expression level and a scrambled mean expression level. These two resultant tibbles and then used to create a statistically summary of the differences in ligand and receptor levels with the third function.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>lig_rec_means <span class="ot">&lt;-</span> <span class="fu">ligand_receptor_means</span>(<span class="at">ligand_mean_dataframe=</span>expr_ligs,<span class="at">receptor_mean_dataframe=</span>expr_recs,<span class="at">ligand_receptor_pairs=</span>ramilowski_pairs,<span class="at">number_cell_types=</span><span class="fu">length</span>(pbmc3k_filtered_split))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>lig_rec_scram <span class="ot">&lt;-</span> <span class="fu">ligand_receptor_scramble</span>(<span class="at">ligand_receptor_means=</span>lig_rec_means,<span class="at">ligand_mean_dataframe=</span>expr_ligs,<span class="at">receptor_mean_dataframe=</span>expr_recs,<span class="at">ligand_receptor_pairs=</span>ramilowski_pairs,<span class="at">number_cell_types=</span><span class="fu">length</span>(pbmc3k_filtered_split),<span class="at">scramble_times=</span><span class="dv">10</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>stats <span class="ot">&lt;-</span> <span class="fu">ligand_receptor_stats</span>(<span class="at">ligand_receptor_means=</span>lig_rec_means,<span class="at">ligand_receptor_scramble=</span>lig_rec_scram)</span></code></pre></div>
</div>
<div id="create-circos-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#create-circos-plot" class="anchor"></a>Create circos plot</h2>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ID top 3 interactions per cell type</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>top_stats <span class="ot">&lt;-</span> stats <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fdr=</span><span class="fu">p.adjust</span>(p_val,<span class="at">method=</span><span class="st">"fdr"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fdr<span class="sc">&lt;</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cell_type1) <span class="sc">%&gt;%</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">3</span>,interact_ratio) <span class="sc">%&gt;%</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>colours_use <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="at">n=</span><span class="fu">length</span>(pbmc3k_filtered_split),<span class="st">"Set2"</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="fu">circos_plot</span>(<span class="at">ligand.receptor.frame=</span>top_stats,<span class="at">colors=</span>colours_use,<span class="at">lig.col=</span><span class="st">"blue"</span>,<span class="at">rec.col=</span><span class="st">"red"</span>)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="celltalker_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>We have now demonstrated a use case for celltalker in which we identified the top 3 ligand/receptor interactions by joint mean expression of cognate ligands and receptors across cell types.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#set-up-analysis">Set up analysis</a></li>
      <li><a href="#dimensional-reduction-and-clustering">Dimensional reduction and clustering</a></li>
      <li><a href="#assign-cell-types">Assign cell types</a></li>
      <li><a href="#create-mean-expression-matrices">Create mean expression matrices</a></li>
      <li><a href="#run-celltalker">Run celltalker</a></li>
      <li><a href="#create-circos-plot">Create circos plot</a></li>
      <li><a href="#conclusion">Conclusion</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Anthony Cillo.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
